<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
/* ... same CSS as before ... */
</style>
</head>
<body>
<header>
  <h2 id="school-name">ğŸ« School Dashboard</h2>
  <div class="plan-badge" id="badge">BASIC</div>
</header>

<section class="dashboard" id="dash">
  <!-- Feature Cards (same as before) -->
  <div class="card locked" data-feature="attendance"><h3>ğŸ“Š Attendance</h3><p>Daily attendance tracking</p></div>
  <div class="card locked" data-feature="students"><h3>ğŸ‘¨â€ğŸ“ Students</h3><p>Student database management</p></div>
  <div class="card locked" data-feature="reports"><h3>ğŸ“ˆ Reports</h3><p>Monthly reports generation</p></div>
  <div class="card locked" data-feature="analytics"><h3>ğŸ“Š Analytics</h3><p>Insights & analytics dashboard</p></div>
  <div class="card locked" data-feature="qr"><h3>ğŸ“± QR Attendance</h3><p>Scan based attendance system</p></div>
  <div class="card locked" data-feature="export"><h3>ğŸ“¤ Export</h3><p>Excel / PDF export functionality</p></div>
  <div class="card locked" data-feature="teachers"><h3>ğŸ‘¨â€ğŸ« Teachers</h3><p>Multi teacher support</p></div>
  <div class="card locked" data-feature="settings"><h3>âš™ï¸ Settings</h3><p>Profile & school settings</p></div>
  
  <!-- Manage Subdomains Card -->
  <div class="card always-visible">
    <div class="history-header">
      <h3>ğŸ“ Manage Subdomains</h3>
      <span class="history-count" id="subdomainCount">0</span>
    </div>
    
    <p>Create teacher/student/public pages</p>
    
    <div class="quick-actions">
      <button onclick="loadSubdomains()" class="action-btn refresh-btn">ğŸ”„ Refresh List</button>
    </div>
    
    <div id="subdomainsList">
      <div class="empty-state">
        <p>ğŸ“­ No subdomains created yet</p>
        <p style="font-size:12px;">Create your first subdomain below</p>
      </div>
    </div>
    
    <button onclick="openSubdomainModal()" class="create-btn">
      â• Create New Subdomain
    </button>
  </div>
</section>

<button class="upgrade" onclick="openPlanModal()">Upgrade Plan</button>

<!-- Modals (same as before) -->
<div class="modal" id="planModal">
  <div class="modal-box">
    <h3>Choose Plan</h3>
    <div class="plan"><b>Intermediate - â‚¹499</b><p>Reports + Attendance</p><button onclick="fakePay('intermediate')">Select Plan</button></div>
    <div class="plan"><b>Pro - â‚¹999</b><p>All features unlocked</p><button onclick="fakePay('pro')">Select Plan</button></div>
    <button onclick="closePlanModal()" class="btn-cancel">Cancel</button>
  </div>
</div>

<div class="modal" id="subdomainModal">
  <div class="modal-box">
    <h3>â• Create New Subdomain</h3>
    <div class="subdomain-form">
      <input type="text" id="subdomainName" placeholder="subdomain-name" required>
      <select id="subdomainType">
        <option value="teacher">ğŸ‘¨â€ğŸ« Teacher</option>
        <option value="student">ğŸ‘¨â€ğŸ“ Student</option>
        <option value="public">ğŸŒ Public Page</option>
      </select>
      <input type="text" id="displayName" placeholder="Display Name">
      <textarea id="subdomainDesc" placeholder="Description" rows="3"></textarea>
      <button onclick="createSubdomain()" class="btn-create">ğŸš€ Create Subdomain</button>
      <button onclick="closeSubdomainModal()" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
// Dynamic values injected from server
let PLAN = "BASIC";
let SCHOOL_NAME = "School";
let MAIN_DOMAIN = "";
let BASE_URL = "http://localhost:5000"; // Will be replaced by server

console.log("Dashboard initialized:", { 
  PLAN, 
  SCHOOL_NAME, 
  MAIN_DOMAIN, 
  BASE_URL,
  currentURL: window.location.href
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log("Page loaded from:", window.location.origin);
  
  // If BASE_URL is still localhost but we're on production, fix it
  if (BASE_URL.includes("localhost") && !window.location.href.includes("localhost")) {
    BASE_URL = window.location.origin;
    console.log("Fixed BASE_URL to:", BASE_URL);
  }
  
  applyPlan();
  setTimeout(() => {
    if (MAIN_DOMAIN) {
      loadSubdomains();
    } else {
      console.error("MAIN_DOMAIN not set!");
    }
  }, 100);
});

function applyPlan() {
  document.getElementById("badge").innerText = PLAN.toUpperCase();
  document.getElementById("school-name").innerText = `ğŸ« ${SCHOOL_NAME} Dashboard`;
  
  document.querySelectorAll('.card[data-feature]').forEach(card => {
    card.classList.add("locked");
  });
  
  if (PLAN === "intermediate" || PLAN === "INTERMEDIATE") {
    unlock(["attendance", "reports"]);
  } else if (PLAN === "pro" || PLAN === "PRO") {
    unlock(["attendance", "reports", "students", "analytics", "qr", "export", "teachers", "settings"]);
  }
}

function unlock(features) {
  features.forEach(feature => {
    const el = document.querySelector(`[data-feature="${feature}"]`);
    if (el) el.classList.remove("locked");
  });
}

// Modal functions
function openPlanModal() { document.getElementById("planModal").style.display = "flex"; }
function closePlanModal() { document.getElementById("planModal").style.display = "none"; }
function openSubdomainModal() { document.getElementById("subdomainModal").style.display = "flex"; }
function closeSubdomainModal() { 
  document.getElementById("subdomainModal").style.display = "none";
  document.getElementById("subdomainName").value = "";
  document.getElementById("displayName").value = "";
  document.getElementById("subdomainDesc").value = "";
}

function fakePay(plan) {
  PLAN = plan;
  document.getElementById("planModal").style.display = "none";
  applyPlan();
  showNotification(`âœ… Plan upgraded to ${plan.toUpperCase()}!`, "success");
}

// Notification
function showNotification(message, type = "success") {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = "block";
  setTimeout(() => notification.style.display = "none", 3000);
}

// Create Subdomain
function createSubdomain() {
  const subdomain = document.getElementById("subdomainName").value.trim();
  const type = document.getElementById("subdomainType").value;
  const name = document.getElementById("displayName").value.trim() || subdomain;
  const description = document.getElementById("subdomainDesc").value.trim();
  
  if (!subdomain) {
    showNotification("âŒ Subdomain name is required", "error");
    return;
  }
  
  if (!MAIN_DOMAIN) {
    showNotification("âŒ Domain not found", "error");
    return;
  }
  
  fetch("/create-subdomain", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mainDomain: MAIN_DOMAIN,
      subdomain: subdomain,
      type: type,
      name: name,
      description: description
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      showNotification(`âŒ ${data.error}`, "error");
    } else {
      showNotification(`âœ… ${data.message}`, "success");
      closeSubdomainModal();
      
      setTimeout(() => {
        loadSubdomains();
        if (data.accessLink) {
          window.open(data.accessLink, '_blank');
        }
      }, 500);
    }
  })
  .catch(error => {
    console.error("Error:", error);
    showNotification("âŒ Network error", "error");
  });
}

// Load Subdomains - DYNAMIC URLS
function loadSubdomains() {
  if (!MAIN_DOMAIN) return;
  
  fetch(`/get-subdomains/${MAIN_DOMAIN}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("subdomainsList");
      const countElement = document.getElementById("subdomainCount");
      
      if (!data.success || !data.subdomains || data.subdomains.length === 0) {
        list.innerHTML = `<div class="empty-state"><p>ğŸ“­ No subdomains yet</p></div>`;
        countElement.textContent = "0";
        return;
      }
      
      countElement.textContent = data.subdomains.length;
      
      const sortedSubdomains = data.subdomains.sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      let html = "";
      sortedSubdomains.forEach((sub, index) => {
        const badgeClass = `${sub.type}-badge`;
        const badgeText = sub.type.charAt(0).toUpperCase() + sub.type.slice(1);
        
        // Dynamic URL construction
        const fullUrl = `${BASE_URL}/${MAIN_DOMAIN}/${sub.subdomain}`;
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(fullUrl)}`;
        const createdDate = new Date(sub.createdAt).toLocaleDateString();
        
        let icon = "ğŸ‘¤";
        if (sub.type === 'teacher') icon = "ğŸ‘¨â€ğŸ«";
        if (sub.type === 'student') icon = "ğŸ‘¨â€ğŸ“";
        if (sub.type === 'public') icon = "ğŸŒ";
        
        html += `
          <div class="subdomain-item">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <span class="subdomain-badge ${badgeClass}">${badgeText}</span>
                <strong>${icon} ${sub.name}</strong>
                <span style="margin-left:8px;font-size:11px;color:#9ca3af;">#${index + 1}</span>
              </div>
              <small style="color:#6b7280;">${createdDate}</small>
            </div>
            
            <div style="display:flex;align-items:center;gap:15px;margin-top:10px;">
              <div style="flex:1;">
                <a href="${fullUrl}" target="_blank" class="subdomain-link">
                  ğŸ”— ${MAIN_DOMAIN}/${sub.subdomain}
                </a>
                ${sub.description ? `<small style="color:#9ca3af;display:block;margin-top:5px;">${sub.description}</small>` : ''}
              </div>
              <div style="text-align:center;">
                <img src="${qrCodeUrl}" alt="QR" class="qr-small">
                <small style="font-size:10px;color:#6b7280;">Scan QR</small>
              </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
              <small style="color:#6b7280;">ğŸ†” ${sub.subdomain}</small>
              <button onclick="copyLink('${fullUrl}', event)" style="background:none;border:1px solid var(--border);color:var(--blue);padding:3px 10px;border-radius:5px;font-size:11px;cursor:pointer;">
                ğŸ“‹ Copy
              </button>
            </div>
          </div>
        `;
      });
      
      list.innerHTML = html;
    })
    .catch(error => {
      console.error("Error:", error);
      document.getElementById("subdomainsList").innerHTML = `
        <div class="empty-state">
          <p>âŒ Error loading</p>
          <p style="font-size:12px;">Please try again</p>
        </div>
      `;
    });
}

function copyLink(url, event) {
  navigator.clipboard.writeText(url)
    .then(() => {
      const button = event.target;
      button.textContent = "âœ… Copied!";
      setTimeout(() => button.textContent = "ğŸ“‹ Copy", 2000);
    });
}

// Auto-refresh
setInterval(() => {
  if (MAIN_DOMAIN) loadSubdomains();
}, 30000);

// Global functions
window.openSubdomainModal = openSubdomainModal;
window.createSubdomain = createSubdomain;
window.loadSubdomains = loadSubdomains;
</script>
</body>
</html>