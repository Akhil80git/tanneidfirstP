<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
/* ... same CSS as before ... */
:root {
  --bg: #0b0f1a;
  --card: #111827;
  --border: #1f2937;
  --gold: #facc15;
  --blue: #38bdf8;
  --green: #10b981;
  --red: #ef4444;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #020617, #020617, #020617);
  color: white;
  min-height: 100vh;
}

/* Header */
header {
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
}

.plan-badge {
  padding: 6px 14px;
  border-radius: 20px;
  background: var(--gold);
  color: #000;
  font-weight: 700;
  font-size: 14px;
}

/* Dashboard Grid */
.dashboard {
  padding: 20px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 16px;
}

/* Cards */
.card {
  background: linear-gradient(180deg, #020617, #020617);
  border: 1px solid var(--border);
  border-radius: 18px;
  padding: 20px;
  min-height: 120px;
  position: relative;
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-5px);
  box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
}

.card h3 {
  margin: 0 0 6px;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card p {
  font-size: 13px;
  color: #9ca3af;
  line-height: 1.4;
}

/* Locked Cards */
.locked {
  filter: blur(1px);
  opacity: 0.6;
}

.locked::after {
  content: "ğŸ”’ Upgrade";
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 700;
  font-size: 14px;
  background: rgba(0, 0, 0, 0.6);
  border-radius: 18px;
}

/* ALWAYS VISIBLE CARD */
.always-visible {
  filter: none !important;
  opacity: 1 !important;
  grid-column: span 2;
  min-height: auto;
}

.always-visible::after {
  content: none !important;
}

/* Upgrade Button */
.upgrade {
  position: fixed;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 26px;
  background: linear-gradient(135deg, #facc15, #fde047);
  color: #000;
  border-radius: 40px;
  font-weight: 800;
  border: none;
  box-shadow: 0 10px 30px rgba(250, 204, 21, 0.6);
  cursor: pointer;
  transition: all 0.3s;
}

.upgrade:hover {
  transform: translateX(-50%) translateY(-3px);
  box-shadow: 0 15px 35px rgba(250, 204, 21, 0.7);
}

/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-box {
  background: #020617;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  border: 1px solid var(--border);
}

.plan {
  padding: 14px;
  border: 1px solid var(--border);
  border-radius: 14px;
  margin-bottom: 12px;
}

.plan button {
  width: 100%;
  margin-top: 8px;
  padding: 10px;
  border-radius: 10px;
  border: none;
  font-weight: 700;
  cursor: pointer;
}

/* History Section */
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.history-count {
  background: var(--blue);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

#subdomainsList {
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 5px;
}

/* Scrollbar */
#subdomainsList::-webkit-scrollbar {
  width: 5px;
}

#subdomainsList::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

#subdomainsList::-webkit-scrollbar-thumb {
  background: var(--blue);
  border-radius: 10px;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 20px;
  color: #9ca3af;
}

.empty-state p {
  margin: 5px 0;
}

/* Quick Actions */
.quick-actions {
  display: flex;
  gap: 10px;
  margin: 10px 0;
}

.action-btn {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s;
}

.action-btn:hover {
  transform: translateY(-2px);
}

.refresh-btn {
  background: var(--green);
  color: white;
}

/* Create Button - IMPORTANT FIX */
.create-btn {
  width: 100%;
  padding: 12px;
  background: var(--blue);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 15px;
  display: block !important;
}

.create-btn:hover {
  background: #2563eb;
  transform: translateY(-2px);
}

/* Subdomain Items */
.subdomain-item {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  margin: 8px 0;
  transition: all 0.3s;
}

.subdomain-item:hover {
  background: rgba(255, 255, 255, 0.08);
  transform: translateY(-2px);
}

.subdomain-link {
  color: var(--blue);
  text-decoration: none;
  font-weight: bold;
  display: block;
  margin: 5px 0;
  padding: 8px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 8px;
  border-left: 3px solid var(--blue);
  transition: all 0.3s;
  word-break: break-all;
}

.subdomain-link:hover {
  text-decoration: underline;
  background: rgba(59, 130, 246, 0.2);
}

.subdomain-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
  margin-right: 8px;
  color: white;
}

.teacher-badge { background: #3b82f6; }
.student-badge { background: #10b981; }
.public-badge { background: #f59e0b; }

/* Subdomain Form */
.subdomain-form input,
.subdomain-form select,
.subdomain-form textarea {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.05);
  color: white;
  font-size: 14px;
}

.subdomain-form textarea {
  min-height: 80px;
  resize: vertical;
}

.subdomain-form button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}

.btn-create {
  background: var(--blue);
  color: white;
}

.btn-cancel {
  background: #4b5563;
  color: white;
}

/* QR Code */
.qr-small {
  width: 80px;
  height: 80px;
  border: 5px solid white;
  border-radius: 8px;
  margin: 10px auto;
  display: block;
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  z-index: 9999;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  display: none;
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.success { background: var(--green); color: white; }
.error { background: var(--red); color: white; }

/* Make sure buttons are visible */
button {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}
</style>
</head>
<body>
<header>
  <h2 id="school-name">ğŸ« School Dashboard</h2>
  <div class="plan-badge" id="badge">BASIC</div>
</header>

<section class="dashboard" id="dash">
  <!-- Feature Cards (same as before) -->
  <div class="card locked" data-feature="attendance"><h3>ğŸ“Š Attendance</h3><p>Daily attendance tracking</p></div>
  <div class="card locked" data-feature="students"><h3>ğŸ‘¨â€ğŸ“ Students</h3><p>Student database management</p></div>
  <div class="card locked" data-feature="reports"><h3>ğŸ“ˆ Reports</h3><p>Monthly reports generation</p></div>
  <div class="card locked" data-feature="analytics"><h3>ğŸ“Š Analytics</h3><p>Insights & analytics dashboard</p></div>
  <div class="card locked" data-feature="qr"><h3>ğŸ“± QR Attendance</h3><p>Scan based attendance system</p></div>
  <div class="card locked" data-feature="export"><h3>ğŸ“¤ Export</h3><p>Excel / PDF export functionality</p></div>
  <div class="card locked" data-feature="teachers"><h3>ğŸ‘¨â€ğŸ« Teachers</h3><p>Multi teacher support</p></div>
  <div class="card locked" data-feature="settings"><h3>âš™ï¸ Settings</h3><p>Profile & school settings</p></div>
  
  <!-- Manage Subdomains Card -->
  <div class="card always-visible">
    <div class="history-header">
      <h3>ğŸ“ Manage Subdomains</h3>
      <span class="history-count" id="subdomainCount">0</span>
    </div>
    
    <p>Create teacher/student/public pages</p>
    
    <div class="quick-actions">
      <button onclick="loadSubdomains()" class="action-btn refresh-btn">ğŸ”„ Refresh List</button>
    </div>
    
    <div id="subdomainsList">
      <div class="empty-state">
        <p>ğŸ“­ No subdomains created yet</p>
        <p style="font-size:12px;">Create your first subdomain below</p>
      </div>
    </div>
    
    <button onclick="openSubdomainModal()" class="create-btn">
      â• Create New Subdomain
    </button>
  </div>
</section>

<button class="upgrade" onclick="openPlanModal()">Upgrade Plan</button>

<!-- Modals (same as before) -->
<div class="modal" id="planModal">
  <div class="modal-box">
    <h3>Choose Plan</h3>
    <div class="plan"><b>Intermediate - â‚¹499</b><p>Reports + Attendance</p><button onclick="fakePay('intermediate')">Select Plan</button></div>
    <div class="plan"><b>Pro - â‚¹999</b><p>All features unlocked</p><button onclick="fakePay('pro')">Select Plan</button></div>
    <button onclick="closePlanModal()" class="btn-cancel">Cancel</button>
  </div>
</div>

<div class="modal" id="subdomainModal">
  <div class="modal-box">
    <h3>â• Create New Subdomain</h3>
    <div class="subdomain-form">
      <input type="text" id="subdomainName" placeholder="subdomain-name" required>
      <select id="subdomainType">
        <option value="teacher">ğŸ‘¨â€ğŸ« Teacher</option>
        <option value="student">ğŸ‘¨â€ğŸ“ Student</option>
        <option value="public">ğŸŒ Public Page</option>
      </select>
      <input type="text" id="displayName" placeholder="Display Name">
      <textarea id="subdomainDesc" placeholder="Description" rows="3"></textarea>
      <button onclick="createSubdomain()" class="btn-create">ğŸš€ Create Subdomain</button>
      <button onclick="closeSubdomainModal()" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="notification" class="notification"></div>

<script>
// Dynamic values injected from server
let PLAN = "BASIC";
let SCHOOL_NAME = "School";
let MAIN_DOMAIN = "";
let BASE_URL = "http://localhost:5000"; // Will be replaced by server

console.log("Dashboard initialized:", { 
  PLAN, 
  SCHOOL_NAME, 
  MAIN_DOMAIN, 
  BASE_URL,
  currentURL: window.location.href
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log("Page loaded from:", window.location.origin);
  
  // If BASE_URL is still localhost but we're on production, fix it
  if (BASE_URL.includes("localhost") && !window.location.href.includes("localhost")) {
    BASE_URL = window.location.origin;
    console.log("Fixed BASE_URL to:", BASE_URL);
  }
  
  applyPlan();
  setTimeout(() => {
    if (MAIN_DOMAIN) {
      loadSubdomains();
    } else {
      console.error("MAIN_DOMAIN not set!");
    }
  }, 100);
});

function applyPlan() {
  document.getElementById("badge").innerText = PLAN.toUpperCase();
  document.getElementById("school-name").innerText = `ğŸ« ${SCHOOL_NAME} Dashboard`;
  
  document.querySelectorAll('.card[data-feature]').forEach(card => {
    card.classList.add("locked");
  });
  
  if (PLAN === "intermediate" || PLAN === "INTERMEDIATE") {
    unlock(["attendance", "reports"]);
  } else if (PLAN === "pro" || PLAN === "PRO") {
    unlock(["attendance", "reports", "students", "analytics", "qr", "export", "teachers", "settings"]);
  }
}

function unlock(features) {
  features.forEach(feature => {
    const el = document.querySelector(`[data-feature="${feature}"]`);
    if (el) el.classList.remove("locked");
  });
}

// Modal functions
function openPlanModal() { document.getElementById("planModal").style.display = "flex"; }
function closePlanModal() { document.getElementById("planModal").style.display = "none"; }
function openSubdomainModal() { document.getElementById("subdomainModal").style.display = "flex"; }
function closeSubdomainModal() { 
  document.getElementById("subdomainModal").style.display = "none";
  document.getElementById("subdomainName").value = "";
  document.getElementById("displayName").value = "";
  document.getElementById("subdomainDesc").value = "";
}

function fakePay(plan) {
  PLAN = plan;
  document.getElementById("planModal").style.display = "none";
  applyPlan();
  showNotification(`âœ… Plan upgraded to ${plan.toUpperCase()}!`, "success");
}

// Notification
function showNotification(message, type = "success") {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.style.display = "block";
  setTimeout(() => notification.style.display = "none", 3000);
}

// Create Subdomain
function createSubdomain() {
  const subdomain = document.getElementById("subdomainName").value.trim();
  const type = document.getElementById("subdomainType").value;
  const name = document.getElementById("displayName").value.trim() || subdomain;
  const description = document.getElementById("subdomainDesc").value.trim();
  
  if (!subdomain) {
    showNotification("âŒ Subdomain name is required", "error");
    return;
  }
  
  if (!MAIN_DOMAIN) {
    showNotification("âŒ Domain not found", "error");
    return;
  }
  
  fetch("/create-subdomain", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mainDomain: MAIN_DOMAIN,
      subdomain: subdomain,
      type: type,
      name: name,
      description: description
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.error) {
      showNotification(`âŒ ${data.error}`, "error");
    } else {
      showNotification(`âœ… ${data.message}`, "success");
      closeSubdomainModal();
      
      setTimeout(() => {
        loadSubdomains();
        if (data.accessLink) {
          window.open(data.accessLink, '_blank');
        }
      }, 500);
    }
  })
  .catch(error => {
    console.error("Error:", error);
    showNotification("âŒ Network error", "error");
  });
}

// Load Subdomains - DYNAMIC URLS
function loadSubdomains() {
  if (!MAIN_DOMAIN) return;
  
  fetch(`/get-subdomains/${MAIN_DOMAIN}`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("subdomainsList");
      const countElement = document.getElementById("subdomainCount");
      
      if (!data.success || !data.subdomains || data.subdomains.length === 0) {
        list.innerHTML = `<div class="empty-state"><p>ğŸ“­ No subdomains yet</p></div>`;
        countElement.textContent = "0";
        return;
      }
      
      countElement.textContent = data.subdomains.length;
      
      const sortedSubdomains = data.subdomains.sort((a, b) => 
        new Date(b.createdAt) - new Date(a.createdAt)
      );
      
      let html = "";
      sortedSubdomains.forEach((sub, index) => {
        const badgeClass = `${sub.type}-badge`;
        const badgeText = sub.type.charAt(0).toUpperCase() + sub.type.slice(1);
        
        // Dynamic URL construction
        const fullUrl = `${BASE_URL}/${MAIN_DOMAIN}/${sub.subdomain}`;
        const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(fullUrl)}`;
        const createdDate = new Date(sub.createdAt).toLocaleDateString();
        
        let icon = "ğŸ‘¤";
        if (sub.type === 'teacher') icon = "ğŸ‘¨â€ğŸ«";
        if (sub.type === 'student') icon = "ğŸ‘¨â€ğŸ“";
        if (sub.type === 'public') icon = "ğŸŒ";
        
        html += `
          <div class="subdomain-item">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div>
                <span class="subdomain-badge ${badgeClass}">${badgeText}</span>
                <strong>${icon} ${sub.name}</strong>
                <span style="margin-left:8px;font-size:11px;color:#9ca3af;">#${index + 1}</span>
              </div>
              <small style="color:#6b7280;">${createdDate}</small>
            </div>
            
            <div style="display:flex;align-items:center;gap:15px;margin-top:10px;">
              <div style="flex:1;">
                <a href="${fullUrl}" target="_blank" class="subdomain-link">
                  ğŸ”— ${MAIN_DOMAIN}/${sub.subdomain}
                </a>
                ${sub.description ? `<small style="color:#9ca3af;display:block;margin-top:5px;">${sub.description}</small>` : ''}
              </div>
              <div style="text-align:center;">
                <img src="${qrCodeUrl}" alt="QR" class="qr-small">
                <small style="font-size:10px;color:#6b7280;">Scan QR</small>
              </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;margin-top:8px;">
              <small style="color:#6b7280;">ğŸ†” ${sub.subdomain}</small>
              <button onclick="copyLink('${fullUrl}', event)" style="background:none;border:1px solid var(--border);color:var(--blue);padding:3px 10px;border-radius:5px;font-size:11px;cursor:pointer;">
                ğŸ“‹ Copy
              </button>
            </div>
          </div>
        `;
      });
      
      list.innerHTML = html;
    })
    .catch(error => {
      console.error("Error:", error);
      document.getElementById("subdomainsList").innerHTML = `
        <div class="empty-state">
          <p>âŒ Error loading</p>
          <p style="font-size:12px;">Please try again</p>
        </div>
      `;
    });
}

function copyLink(url, event) {
  navigator.clipboard.writeText(url)
    .then(() => {
      const button = event.target;
      button.textContent = "âœ… Copied!";
      setTimeout(() => button.textContent = "ğŸ“‹ Copy", 2000);
    });
}

// Auto-refresh
setInterval(() => {
  if (MAIN_DOMAIN) loadSubdomains();
}, 30000);

// Global functions
window.openSubdomainModal = openSubdomainModal;
window.createSubdomain = createSubdomain;
window.loadSubdomains = loadSubdomains;
</script>
</body>
</html>