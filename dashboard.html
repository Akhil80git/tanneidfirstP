<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
:root{--bg:#0b0f1a;--card:#111827;--border:#1f2937;--gold:#facc15;--blue:#38bdf8;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:Inter,system-ui;background:linear-gradient(135deg,#020617,#020617,#020617);color:#fff;min-height:100vh;}
header{padding:16px 20px;display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);}
.plan-badge{padding:6px 14px;border-radius:20px;background:var(--gold);color:#000;font-weight:700;}
.dashboard{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;}
.card{background:linear-gradient(180deg,#020617,#020617);border:1px solid var(--border);border-radius:18px;padding:20px;min-height:120px;position:relative;box-shadow:0 20px 50px rgba(0,0,0,.4);}
.card h3{margin:0 0 6px}
.card p{font-size:13px;color:#9ca3af}
.locked{filter:blur(1px);opacity:.6}
.locked::after{content:"ğŸ”’ Upgrade";position:absolute;inset:0;display:flex;justify-content:center;align-items:center;font-weight:700;font-size:14px;background:rgba(0,0,0,.6);border-radius:18px;}
.upgrade{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);padding:14px 26px;background:linear-gradient(135deg,#facc15,#fde047);color:#000;border-radius:40px;font-weight:800;border:none;box-shadow:0 10px 30px rgba(250,204,21,.6);cursor:pointer;}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;z-index:1000;}
.modal-box{background:#020617;padding:25px;border-radius:20px;width:90%;max-width:400px;border:1px solid var(--border);}
.plan{padding:14px;border:1px solid var(--border);border-radius:14px;margin-bottom:12px;}
.plan button{width:100%;margin-top:8px;padding:10px;border-radius:10px;border:none;font-weight:700;cursor:pointer;}

/* Subdomain Styling */
.subdomain-item {
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px;
  margin: 8px 0;
  transition: all 0.3s;
}

.subdomain-item:hover {
  background: rgba(255,255,255,0.08);
  transform: translateY(-2px);
}

.subdomain-link {
  color: var(--blue);
  text-decoration: none;
  font-weight: bold;
  display: block;
  margin: 5px 0;
  padding: 8px;
  background: rgba(59,130,246,0.1);
  border-radius: 8px;
  border-left: 3px solid var(--blue);
}

.subdomain-link:hover {
  text-decoration: underline;
  background: rgba(59,130,246,0.2);
}

.subdomain-badge {
  display: inline-block;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: bold;
  margin-right: 8px;
}

.teacher-badge { background: #3b82f6; }
.student-badge { background: #10b981; }
.public-badge { background: #f59e0b; }

.subdomain-form input,
.subdomain-form select,
.subdomain-form textarea {
  width: 100%;
  padding: 12px;
  margin: 10px 0;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.05);
  color: white;
  font-size: 14px;
}

.subdomain-form button {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}

.btn-create { background: var(--blue); color: white; }
.btn-cancel { background: #4b5563; color: white; }

/* ALWAYS VISIBLE CARD */
.always-visible {
  filter: none !important;
  opacity: 1 !important;
  grid-column: span 2 !important;
}
.always-visible::after {
  content: none !important;
}

/* History Section */
.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.history-count {
  background: var(--blue);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
}

#subdomainsList {
  margin-top: 15px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 5px;
}

#subdomainsList::-webkit-scrollbar {
  width: 5px;
}

#subdomainsList::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

#subdomainsList::-webkit-scrollbar-thumb {
  background: var(--blue);
  border-radius: 10px;
}

.empty-state {
  text-align: center;
  padding: 20px;
  color: #9ca3af;
}

.empty-state p {
  margin: 5px 0;
}

.quick-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.action-btn {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
}

.refresh-btn {
  background: #10b981;
  color: white;
}

.delete-all-btn {
  background: #ef4444;
  color: white;
}

#notification {
  position:fixed; 
  top:20px; 
  right:20px; 
  background:#10b981; 
  color:white; 
  padding:15px 20px; 
  border-radius:10px; 
  display:none; 
  z-index:9999; 
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
}

/* QR Code in List */
.qr-small {
  width: 80px;
  height: 80px;
  border: 4px solid white;
  border-radius: 8px;
  margin: 5px auto;
  display: block;
}

.qr-container {
  text-align: center;
  margin: 10px 0;
  padding: 8px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
}

.id-display {
  font-family: monospace;
  font-size: 10px;
  color: #93c5fd;
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 4px;
  margin: 5px 0;
  word-break: break-all;
}
</style>
</head>
<body>
<header>
  <h2 id="school-name">ğŸ« School Dashboard</h2>
  <div class="plan-badge" id="badge">BASIC</div>
</header>
<section class="dashboard" id="dash">
  <div class="card locked" data-feature="attendance"><h3>Attendance</h3><p>Daily attendance</p></div>
  <div class="card locked" data-feature="students"><h3>Students</h3><p>Student database</p></div>
  <div class="card locked" data-feature="reports"><h3>Reports</h3><p>Monthly reports</p></div>
  <div class="card locked" data-feature="analytics"><h3>Analytics</h3><p>Insights</p></div>
  <div class="card locked" data-feature="qr"><h3>QR Attendance</h3><p>Scan based</p></div>
  <div class="card locked" data-feature="export"><h3>Export</h3><p>Excel / PDF</p></div>
  <div class="card locked" data-feature="teachers"><h3>Teachers</h3><p>Multi teacher</p></div>
  <div class="card locked" data-feature="settings"><h3>Settings</h3><p>Profile & school</p></div>
  
  <!-- ALWAYS VISIBLE CARD -->
  <div class="card always-visible" id="manageCard">
    <div class="history-header">
      <h3>ğŸ“ Manage Subdomains</h3>
      <span class="history-count" id="subdomainCount">0 Created</span>
    </div>
    <p>Create teacher/student/public pages</p>
    
    <div class="quick-actions">
      <button onclick="loadSubdomains()" class="action-btn refresh-btn">ğŸ”„ Refresh List</button>
      <button onclick="deleteAllSubdomains()" class="action-btn delete-all-btn">ğŸ—‘ï¸ Delete All</button>
    </div>
    
    <div id="subdomainsList">
      <div class="empty-state">
        <p>ğŸ“­ No subdomains created yet</p>
        <p style="font-size: 12px;">Create your first subdomain below</p>
      </div>
    </div>
    
    <button onclick="openSubdomainModal()" style="margin-top: 15px; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 10px; width: 100%; font-weight: bold; font-size: 14px; cursor: pointer;">
      â• Create New Subdomain
    </button>
  </div>
</section>

<button class="upgrade" onclick="openPlanModal()">Upgrade Plan</button>

<!-- Plan Upgrade Modal -->
<div class="modal" id="planModal">
  <div class="modal-box">
    <h3>Choose Plan</h3>
    <div class="plan">
      <b>Intermediate</b>
      <p>Reports + Attendance</p>
      <button onclick="fakePay('intermediate')">Pay â‚¹499</button>
    </div>
    <div class="plan">
      <b>Pro</b>
      <p>All features unlocked</p>
      <button onclick="fakePay('pro')">Pay â‚¹999</button>
    </div>
    <button onclick="closePlanModal()" class="btn-cancel">Cancel</button>
  </div>
</div>

<!-- Subdomain Creation Modal -->
<div class="modal" id="subdomainModal">
  <div class="modal-box">
    <h3>â• Create New Subdomain</h3>
    <div class="subdomain-form">
      <input type="text" id="subdomainName" placeholder="subdomain-name (no spaces)" required>
      <select id="subdomainType">
        <option value="teacher">ğŸ‘¨â€ğŸ« Teacher</option>
        <option value="student">ğŸ‘¨â€ğŸ“ Student</option>
        <option value="public">ğŸŒ Public Page</option>
      </select>
      <input type="text" id="displayName" placeholder="Display Name (e.g., John's Class)">
      <textarea id="subdomainDesc" placeholder="Description" rows="3"></textarea>
      <button onclick="createSubdomain()" class="btn-create">ğŸš€ Create Subdomain</button>
      <button onclick="closeSubdomainModal()" class="btn-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Success Notification -->
<div id="notification">âœ… Subdomain created successfully!</div>

<script>
// VARIABLES THAT WILL BE REPLACED BY SERVER
let PLAN = "BASIC";
let SCHOOL_NAME = "School";
let MAIN_DOMAIN = "";

// Extract domain from URL if not set
function extractDomainFromURL() {
  const path = window.location.pathname;
  if (path.startsWith('/dashboard/')) {
    const parts = path.split('/');
    if (parts.length >= 3) {
      MAIN_DOMAIN = parts[2];
      console.log("âœ… Extracted MAIN_DOMAIN from URL:", MAIN_DOMAIN);
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  console.log("ğŸ“Š Dashboard loaded");
  
  // Try to extract domain from URL
  extractDomainFromURL();
  
  // Update UI
  applyPlan();
  
  // Load subdomains after delay
  setTimeout(() => {
    if (MAIN_DOMAIN) {
      loadSubdomains();
    } else {
      console.error("âŒ MAIN_DOMAIN is empty!");
      document.getElementById("subdomainCount").textContent = "No Domain";
      document.getElementById("subdomainsList").innerHTML = `
        <div class="empty-state">
          <p>âš ï¸ Domain not detected</p>
          <p style="font-size: 12px;">URL: ${window.location.pathname}</p>
          <button onclick="location.reload()" style="margin-top:10px; padding:8px 15px; background:#3b82f6; color:white; border:none; border-radius:5px; cursor:pointer;">
            ğŸ”„ Refresh Page
          </button>
        </div>
      `;
    }
  }, 1000);
});

function applyPlan() {
  // Update badge
  document.getElementById("badge").textContent = PLAN.toUpperCase();
  
  // Update school name
  document.getElementById("school-name").textContent = \`ğŸ« \${SCHOOL_NAME} Dashboard\`;
  
  // Lock all feature cards initially
  document.querySelectorAll('.card[data-feature]').forEach(card => {
    card.classList.add("locked");
  });
  
  // Unlock based on plan
  if (PLAN === "intermediate" || PLAN === "INTERMEDIATE") {
    unlockFeatures(["attendance", "reports"]);
  }
  if (PLAN === "pro" || PLAN === "PRO") {
    unlockFeatures(["attendance", "reports", "students", "analytics", "qr", "export", "teachers", "settings"]);
  }
}

function unlockFeatures(features) {
  features.forEach(feature => {
    const card = document.querySelector(\`[data-feature="\${feature}"]\`);
    if (card) {
      card.classList.remove("locked");
    }
  });
}

// Modal Functions
function openPlanModal() {
  document.getElementById("planModal").style.display = "flex";
}

function closePlanModal() {
  document.getElementById("planModal").style.display = "none";
}

function openSubdomainModal() {
  document.getElementById("subdomainModal").style.display = "flex";
}

function closeSubdomainModal() {
  document.getElementById("subdomainModal").style.display = "none";
  document.getElementById("subdomainName").value = "";
  document.getElementById("displayName").value = "";
  document.getElementById("subdomainDesc").value = "";
}

function fakePay(plan) {
  PLAN = plan;
  closePlanModal();
  applyPlan();
  alert(\`ğŸ‰ Plan upgraded to \${plan.toUpperCase()}!\`);
}

// Notification
function showNotification(message, type = "success") {
  const notification = document.getElementById("notification");
  notification.textContent = message;
  notification.style.background = type === "success" ? "#10b981" : "#ef4444";
  notification.style.display = "block";
  
  setTimeout(() => {
    notification.style.display = "none";
  }, 3000);
}

// Create Subdomain
function createSubdomain() {
  const subdomain = document.getElementById("subdomainName").value.trim();
  const type = document.getElementById("subdomainType").value;
  const name = document.getElementById("displayName").value.trim() || subdomain;
  const description = document.getElementById("subdomainDesc").value.trim();
  
  if (!subdomain) {
    showNotification("âŒ Subdomain name is required", "error");
    return;
  }
  
  if (!MAIN_DOMAIN) {
    showNotification("âŒ Main domain not found", "error");
    return;
  }
  
  // Validate format
  if (!/^[a-zA-Z0-9]+\$/.test(subdomain)) {
    showNotification("âŒ Only letters and numbers allowed", "error");
    return;
  }
  
  console.log("ğŸ“¤ Creating subdomain:", { mainDomain: MAIN_DOMAIN, subdomain, type, name });
  
  fetch("/create-subdomain", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mainDomain: MAIN_DOMAIN,
      subdomain: subdomain,
      type: type,
      name: name,
      description: description
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("ğŸ“¥ Response:", data);
    
    if (data.error) {
      showNotification("âŒ " + data.error, "error");
    } else {
      showNotification("âœ… " + data.message, "success");
      closeSubdomainModal();
      
      // Reload subdomains list
      setTimeout(() => loadSubdomains(), 500);
      
      // Open new subdomain in new tab
      if (data.accessLink) {
        setTimeout(() => window.open(data.accessLink, '_blank'), 1000);
      }
    }
  })
  .catch(error => {
    console.error("âŒ Fetch error:", error);
    showNotification("âŒ Network error. Please try again.", "error");
  });
}

// Load Subdomains - UPDATED FOR NEW DATA STRUCTURE
function loadSubdomains() {
  console.log("ğŸ“¡ Loading subdomains for:", MAIN_DOMAIN);
  
  if (!MAIN_DOMAIN) {
    console.error("MAIN_DOMAIN is empty!");
    showNotification("âŒ Main domain not set", "error");
    return;
  }
  
  document.getElementById("subdomainCount").textContent = "Loading...";
  document.getElementById("subdomainsList").innerHTML = \`
    <div class="empty-state">
      <p>â³ Loading subdomains...</p>
    </div>
  \`;
  
  fetch(\`/get-subdomains/\${MAIN_DOMAIN}\`)
    .then(res => {
      if (!res.ok) throw new Error(\`HTTP \${res.status}\`);
      return res.json();
    })
    .then(data => {
      console.log("ğŸ“¦ Subdomains data:", data);
      
      if (!data.success || data.error) {
        document.getElementById("subdomainsList").innerHTML = \`
          <div class="empty-state">
            <p>ğŸ“­ No subdomains found</p>
            <p style="font-size: 12px;">\${data.error || 'Create your first subdomain'}</p>
          </div>
        \`;
        document.getElementById("subdomainCount").textContent = "0 Created";
        return;
      }
      
      const subdomains = data.subdomains || [];
      document.getElementById("subdomainCount").textContent = \`\${subdomains.length} Created\`;
      
      if (subdomains.length === 0) {
        document.getElementById("subdomainsList").innerHTML = \`
          <div class="empty-state">
            <p>ğŸ“­ No subdomains created yet</p>
            <p style="font-size: 12px;">Create your first subdomain below</p>
          </div>
        \`;
        return;
      }
      
      // Display subdomains with NEW DATA STRUCTURE
      let html = "";
      
      subdomains.forEach((sub, index) => {
        const badgeClass = \`\${sub.type}-badge\`;
        const badgeText = sub.type.charAt(0).toUpperCase() + sub.type.slice(1);
        const createdDate = new Date(sub.createdAt).toLocaleDateString();
        
        let icon = "ğŸ‘¤";
        if (sub.type === 'teacher') icon = "ğŸ‘¨â€ğŸ«";
        if (sub.type === 'student') icon = "ğŸ‘¨â€ğŸ“";
        if (sub.type === 'public') icon = "ğŸŒ";
        
        // Use new fields: uniqueId, qrCodeUrl, fullUrl, shortCode
        const uniqueId = sub.uniqueId || sub.subdomain;
        const qrCodeUrl = sub.qrCodeUrl || \`https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=\${encodeURIComponent(sub.fullUrl || window.location.origin + '/' + MAIN_DOMAIN + '/' + uniqueId)}\`;
        const fullUrl = sub.fullUrl || window.location.origin + '/' + MAIN_DOMAIN + '/' + uniqueId;
        const shortCode = sub.shortCode || uniqueId.substring(0, 8);
        
        html += \`
          <div class="subdomain-item">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div>
                <span class="subdomain-badge \${badgeClass}">\${badgeText}</span>
                <strong>\${icon} \${sub.name}</strong>
                <span style="margin-left: 8px; font-size: 11px; color: #9ca3af;">#\${index + 1}</span>
              </div>
              <small style="color:#6b7280; font-size: 11px;">\${createdDate}</small>
            </div>
            
            \${sub.description ? \`
            <div style="margin: 8px 0; color: #9ca3af; font-size: 13px;">
              ğŸ“ \${sub.description}
            </div>
            \` : ''}
            
            <!-- QR Code Display -->
            <div class="qr-container">
              <img src="\${qrCodeUrl}" alt="QR Code" class="qr-small">
              <div style="font-size: 10px; color: #6b7280; margin-top: 3px;">Scan to open</div>
            </div>
            
            <div class="id-display">
              <strong>ID:</strong> \${shortCode}
            </div>
            
            <a href="\${fullUrl}" target="_blank" class="subdomain-link">
              ğŸ”— Open \${sub.type} Dashboard
            </a>
            
            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
              <button onclick="navigator.clipboard.writeText('\${fullUrl}');alert('âœ… Link copied!')" style="background:none; border:1px solid #3b82f6; color:#3b82f6; padding:3px 10px; border-radius:5px; font-size:11px; cursor:pointer;">
                ğŸ“‹ Copy Link
              </button>
              <button onclick="deleteSubdomain('\${uniqueId}', '\${sub.name}')" style="background:none; border:1px solid #ef4444; color:#ef4444; padding:3px 10px; border-radius:5px; font-size:11px; cursor:pointer;">
                ğŸ—‘ï¸ Delete
              </button>
            </div>
          </div>
        \`;
      });
      
      document.getElementById("subdomainsList").innerHTML = html;
    })
    .catch(error => {
      console.error("âŒ Error loading subdomains:", error);
      document.getElementById("subdomainsList").innerHTML = \`
        <div class="empty-state">
          <p>âŒ Error loading subdomains</p>
          <p style="font-size: 12px;">\${error.message}</p>
        </div>
      \`;
      document.getElementById("subdomainCount").textContent = "Error";
    });
}

// Delete Subdomain - UPDATED TO USE UNIQUE ID
function deleteSubdomain(uniqueId, displayName) {
  if (!confirm(\`Delete "\${displayName}"?\`)) return;
  
  fetch(\`/delete-subdomain/\${MAIN_DOMAIN}/\${uniqueId}\`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotification("âœ… " + data.message, "success");
      loadSubdomains();
    } else {
      showNotification("âŒ " + data.error, "error");
    }
  })
  .catch(error => {
    console.error("Delete error:", error);
    showNotification("âŒ Network error", "error");
  });
}

// Delete All Subdomains
function deleteAllSubdomains() {
  if (!confirm("Delete ALL subdomains? This cannot be undone!")) return;
  
  fetch(\`/delete-all-subdomains/\${MAIN_DOMAIN}\`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotification("âœ… " + data.message, "success");
      loadSubdomains();
    } else {
      showNotification("âŒ " + data.error, "error");
    }
  })
  .catch(error => {
    console.error("Delete all error:", error);
    showNotification("âŒ Network error", "error");
  });
}

// Auto-refresh every 10 seconds
setInterval(() => {
  if (MAIN_DOMAIN) {
    loadSubdomains();
  }
}, 10000);

// Make functions global
window.loadSubdomains = loadSubdomains;
window.createSubdomain = createSubdomain;
</script>
</body>
</html>
