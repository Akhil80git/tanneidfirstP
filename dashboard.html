<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
<style>
:root {
  --bg: #0b0f1a;
  --card: #111827;
  --border: #1f2937;
  --gold: #facc15;
  --blue: #3b82f6;
  --green: #10b981;
  --red: #ef4444;
  --purple: #8b5cf6;
  --orange: #f59e0b;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: linear-gradient(135deg, #020617, #0f172a, #020617);
  color: #f8fafc;
  min-height: 100vh;
  line-height: 1.6;
}

/* Header */
header {
  padding: 1rem 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.school-info h1 {
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.domain-badge {
  font-size: 0.75rem;
  background: var(--blue);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-weight: 600;
}

.plan-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.plan-badge {
  background: var(--gold);
  color: #000;
  padding: 0.5rem 1rem;
  border-radius: 1rem;
  font-weight: 700;
  font-size: 0.875rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.upgrade-btn {
  background: linear-gradient(135deg, #facc15, #fde047);
  color: #000;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 0.75rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.875rem;
}

.upgrade-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(250, 204, 21, 0.4);
}

/* Main Layout */
.container {
  display: flex;
  gap: 1.5rem;
  padding: 1.5rem;
  max-width: 1400px;
  margin: 0 auto;
}

/* Features Grid */
.features-section {
  flex: 1;
}

.features-header {
  margin-bottom: 1.5rem;
}

.features-header h2 {
  font-size: 1.25rem;
  font-weight: 700;
  color: #e2e8f0;
  margin-bottom: 0.5rem;
}

.features-header p {
  color: #94a3b8;
  font-size: 0.875rem;
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 1rem;
}

.feature-card {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 1.25rem;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.feature-card:hover {
  transform: translateY(-4px);
  border-color: var(--blue);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.2);
}

.feature-card.locked {
  filter: grayscale(0.5);
  opacity: 0.6;
}

.feature-card.locked::after {
  content: "üîí Upgrade";
  position: absolute;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: 700;
  font-size: 0.875rem;
  background: rgba(0, 0, 0, 0.7);
  border-radius: 1rem;
  color: var(--gold);
}

.feature-card.active {
  border-color: var(--green);
  background: linear-gradient(145deg, #1e293b, #064e3b);
}

.feature-icon {
  font-size: 1.5rem;
  margin-bottom: 0.75rem;
}

.feature-card h3 {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
  color: #f1f5f9;
}

.feature-card p {
  font-size: 0.75rem;
  color: #94a3b8;
}

/* Subdomains Section */
.subdomains-section {
  flex: 1;
  max-width: 500px;
}

.subdomains-card {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  border: 1px solid var(--border);
  border-radius: 1rem;
  padding: 1.5rem;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.subdomains-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.subdomains-header h2 {
  font-size: 1.25rem;
  font-weight: 700;
  color: #e2e8f0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.subdomain-count {
  background: var(--blue);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 700;
}

.quick-actions {
  display: flex;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}

.action-btn {
  flex: 1;
  padding: 0.75rem;
  border: none;
  border-radius: 0.75rem;
  font-weight: 600;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.refresh-btn {
  background: var(--green);
  color: white;
}

.refresh-btn:hover {
  background: #059669;
  transform: translateY(-2px);
}

.delete-all-btn {
  background: var(--red);
  color: white;
}

.delete-all-btn:hover {
  background: #dc2626;
  transform: translateY(-2px);
}

/* Subdomains List */
.subdomains-list {
  flex: 1;
  overflow-y: auto;
  max-height: 400px;
  margin-bottom: 1.5rem;
}

.subdomains-list::-webkit-scrollbar {
  width: 6px;
}

.subdomains-list::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 3px;
}

.subdomains-list::-webkit-scrollbar-thumb {
  background: var(--blue);
  border-radius: 3px;
}

.subdomain-item {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid var(--border);
  border-radius: 0.75rem;
  padding: 1rem;
  margin-bottom: 0.75rem;
  transition: all 0.3s;
}

.subdomain-item:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: var(--blue);
  transform: translateY(-2px);
}

.subdomain-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
}

.subdomain-type {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.type-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 700;
}

.teacher-badge { background: #3b82f6; color: white; }
.student-badge { background: #10b981; color: white; }
.public-badge { background: #f59e0b; color: #000; }

.subdomain-name {
  font-weight: 600;
  color: #f1f5f9;
}

.subdomain-date {
  font-size: 0.75rem;
  color: #94a3b8;
}

.subdomain-description {
  color: #cbd5e1;
  font-size: 0.875rem;
  margin-bottom: 0.75rem;
}

.subdomain-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
}

.action-small {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 0.5rem;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.25rem;
}

.view-btn {
  background: var(--blue);
  color: white;
}

.view-btn:hover {
  background: #2563eb;
}

.copy-btn {
  background: rgba(59, 130, 246, 0.1);
  color: var(--blue);
  border: 1px solid var(--blue);
}

.copy-btn:hover {
  background: rgba(59, 130, 246, 0.2);
}

.delete-btn {
  background: rgba(239, 68, 68, 0.1);
  color: var(--red);
  border: 1px solid var(--red);
}

.delete-btn:hover {
  background: rgba(239, 68, 68, 0.2);
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #94a3b8;
}

.empty-state .icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
  color: #cbd5e1;
}

.empty-state p {
  font-size: 0.875rem;
  margin-bottom: 1.5rem;
}

.create-subdomain-btn {
  background: linear-gradient(135deg, var(--blue), #1d4ed8);
  color: white;
  border: none;
  padding: 1rem;
  border-radius: 0.75rem;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  width: 100%;
  margin-top: auto;
}

.create-subdomain-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
}

/* QR Code in List */
.qr-container {
  text-align: center;
  margin: 0.75rem 0;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 0.75rem;
}

.qr-small {
  width: 80px;
  height: 80px;
  border: 3px solid white;
  border-radius: 0.5rem;
  margin: 0 auto;
  display: block;
}

.qr-label {
  font-size: 0.75rem;
  color: #94a3b8;
  margin-top: 0.25rem;
}

/* ID Display */
.id-display {
  font-family: 'Courier New', monospace;
  font-size: 0.75rem;
  color: #93c5fd;
  background: rgba(0, 0, 0, 0.3);
  padding: 0.5rem;
  border-radius: 0.5rem;
  margin: 0.5rem 0;
  word-break: break-all;
}

/* Modals */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(5px);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 1rem;
}

.modal-box {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  padding: 2rem;
  border-radius: 1.5rem;
  width: 100%;
  max-width: 400px;
  border: 1px solid var(--border);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
  margin-bottom: 1.5rem;
}

.modal-header h3 {
  font-size: 1.5rem;
  font-weight: 700;
  color: #f1f5f9;
  margin-bottom: 0.5rem;
}

.modal-header p {
  color: #94a3b8;
  font-size: 0.875rem;
}

.plan-options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.plan-card {
  background: rgba(255, 255, 255, 0.03);
  border: 2px solid var(--border);
  border-radius: 1rem;
  padding: 1.25rem;
  transition: all 0.3s;
  cursor: pointer;
}

.plan-card:hover {
  border-color: var(--blue);
  transform: translateY(-2px);
}

.plan-card.selected {
  border-color: var(--gold);
  background: rgba(250, 204, 21, 0.05);
}

.plan-card h4 {
  font-size: 1.125rem;
  font-weight: 700;
  color: #f1f5f9;
  margin-bottom: 0.5rem;
}

.plan-price {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--gold);
  margin-bottom: 0.5rem;
}

.plan-features {
  list-style: none;
  font-size: 0.875rem;
  color: #cbd5e1;
}

.plan-features li {
  margin-bottom: 0.25rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.plan-features li::before {
  content: "‚úì";
  color: var(--green);
  font-weight: bold;
}

.modal-buttons {
  display: flex;
  gap: 1rem;
}

.modal-btn {
  flex: 1;
  padding: 0.875rem;
  border: none;
  border-radius: 0.75rem;
  font-weight: 700;
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary {
  background: var(--blue);
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: #cbd5e1;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Notification */
#notification {
  position: fixed;
  top: 1.5rem;
  right: 1.5rem;
  background: var(--green);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 0.75rem;
  display: none;
  z-index: 9999;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Responsive */
@media (max-width: 1024px) {
  .container {
    flex-direction: column;
  }
  
  .subdomains-section {
    max-width: 100%;
  }
}

@media (max-width: 640px) {
  .features-grid {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  }
  
  header {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .plan-section {
    width: 100%;
    justify-content: space-between;
  }
}
</style>
</head>
<body>
<!-- Header -->
<header>
  <div class="school-info">
    <h1>
      <span>üè´</span>
      <span id="school-name">School Dashboard</span>
      <span class="domain-badge" id="domain-badge">domain</span>
    </h1>
  </div>
  
  <div class="plan-section">
    <div class="plan-badge" id="plan-badge">
      <span>‚≠ê</span>
      <span id="plan-text">BASIC</span>
    </div>
    <button class="upgrade-btn" id="upgradePlanBtn">
      <span>‚ö°</span>
      Upgrade Plan
    </button>
  </div>
</header>

<!-- Main Content -->
<div class="container">
  <!-- Features Section -->
  <section class="features-section">
    <div class="features-header">
      <h2>üìä Dashboard Features</h2>
      <p>Manage your school with these powerful tools</p>
    </div>
    
    <div class="features-grid" id="featuresGrid">
      <!-- Features will be dynamically added -->
    </div>
  </section>
  
  <!-- Subdomains Section -->
  <section class="subdomains-section">
    <div class="subdomains-card">
      <div class="subdomains-header">
        <h2>
          <span>üìÅ</span>
          Manage Subdomains
        </h2>
        <span class="subdomain-count" id="subdomainCount">0 Created</span>
      </div>
      
      <p style="color: #94a3b8; margin-bottom: 1.5rem; font-size: 0.875rem;">
        Create and manage teacher, student, and public dashboards
      </p>
      
      <div class="quick-actions">
        <button class="action-btn refresh-btn" id="refreshBtn">
          <span>üîÑ</span>
          Refresh List
        </button>
        <button class="action-btn delete-all-btn" id="deleteAllBtn">
          <span>üóëÔ∏è</span>
          Delete All
        </button>
      </div>
      
      <div class="subdomains-list" id="subdomainsList">
        <!-- Subdomains will be dynamically added -->
        <div class="empty-state">
          <div class="icon">üì≠</div>
          <h3>No Subdomains Yet</h3>
          <p>Create your first subdomain to get started</p>
        </div>
      </div>
      
      <button class="create-subdomain-btn" id="createSubdomainBtn">
        <span>‚ûï</span>
        Create New Subdomain
      </button>
    </div>
  </section>
</div>

<!-- Upgrade Plan Modal -->
<div class="modal" id="planModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‚ö° Upgrade Your Plan</h3>
      <p>Choose the perfect plan for your school</p>
    </div>
    
    <div class="plan-options">
      <div class="plan-card" data-plan="basic">
        <h4>Basic</h4>
        <div class="plan-price">Free</div>
        <ul class="plan-features">
          <li>Basic Attendance</li>
          <li>Student Database</li>
          <li>5 Subdomains Limit</li>
          <li>Basic Reports</li>
        </ul>
      </div>
      
      <div class="plan-card" data-plan="intermediate">
        <h4>Intermediate</h4>
        <div class="plan-price">‚Çπ499/month</div>
        <ul class="plan-features">
          <li>All Basic Features</li>
          <li>Advanced Reports</li>
          <li>QR Code Attendance</li>
          <li>25 Subdomains</li>
          <li>Analytics Dashboard</li>
        </ul>
      </div>
      
      <div class="plan-card" data-plan="pro">
        <h4>Pro</h4>
        <div class="plan-price">‚Çπ999/month</div>
        <ul class="plan-features">
          <li>All Intermediate Features</li>
          <li>Unlimited Subdomains</li>
          <li>Export Data (Excel/PDF)</li>
          <li>Multi-Teacher Support</li>
          <li>Advanced Settings</li>
          <li>Priority Support</li>
        </ul>
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="modal-btn btn-primary" id="confirmUpgradeBtn">
        Upgrade Now
      </button>
      <button class="modal-btn btn-secondary" id="cancelPlanBtn">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Create Subdomain Modal -->
<div class="modal" id="subdomainModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‚ûï Create New Subdomain</h3>
      <p>Create a dashboard for teachers, students, or public access</p>
    </div>
    
    <div class="subdomain-form">
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem;">
          Subdomain Name
        </label>
        <input type="text" id="subdomainName" 
               placeholder="e.g., johns-class" 
               style="width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; font-size: 1rem;">
        <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">
          Only letters and numbers, no spaces
        </div>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem;">
          Type
        </label>
        <select id="subdomainType" style="width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; font-size: 1rem;">
          <option value="teacher">üë®‚Äçüè´ Teacher Dashboard</option>
          <option value="student">üë®‚Äçüéì Student Dashboard</option>
          <option value="public">üåê Public Portal</option>
        </select>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem;">
          Display Name
        </label>
        <input type="text" id="displayName" 
               placeholder="e.g., Mr. John's Math Class" 
               style="width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; font-size: 1rem;">
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #cbd5e1; font-size: 0.875rem;">
          Description (Optional)
        </label>
        <textarea id="subdomainDesc" 
                  rows="3" 
                  placeholder="Brief description of this dashboard..."
                  style="width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid var(--border); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; resize: vertical;"></textarea>
      </div>
    </div>
    
    <div class="modal-buttons">
      <button class="modal-btn btn-primary" id="createSubdomainSubmitBtn">
        üöÄ Create Subdomain
      </button>
      <button class="modal-btn btn-secondary" id="cancelSubdomainBtn">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Success Notification -->
<div id="notification">‚úÖ Operation completed successfully!</div>

<script>
// VARIABLES THAT WILL BE REPLACED BY SERVER
let PLAN = "BASIC";
let SCHOOL_NAME = "School";
let MAIN_DOMAIN = "";

// Features configuration
const FEATURES = [
  { id: 'attendance', name: 'Attendance', desc: 'Daily attendance tracking', icon: 'üìã', requires: 'basic' },
  { id: 'students', name: 'Students', desc: 'Student database management', icon: 'üë®‚Äçüéì', requires: 'basic' },
  { id: 'reports', name: 'Reports', desc: 'Monthly reports generation', icon: 'üìä', requires: 'intermediate' },
  { id: 'analytics', name: 'Analytics', desc: 'Advanced insights & analytics', icon: 'üìà', requires: 'intermediate' },
  { id: 'qr', name: 'QR Attendance', desc: 'Scan-based attendance system', icon: 'üì±', requires: 'intermediate' },
  { id: 'export', name: 'Export Data', desc: 'Export to Excel/PDF', icon: 'üíæ', requires: 'pro' },
  { id: 'teachers', name: 'Teachers', desc: 'Multi-teacher management', icon: 'üë®‚Äçüè´', requires: 'pro' },
  { id: 'settings', name: 'Settings', desc: 'Advanced configuration', icon: '‚öôÔ∏è', requires: 'pro' }
];

// DOM Elements
const elements = {
  schoolName: document.getElementById('school-name'),
  domainBadge: document.getElementById('domain-badge'),
  planBadge: document.getElementById('plan-badge'),
  planText: document.getElementById('plan-text'),
  subdomainCount: document.getElementById('subdomainCount'),
  subdomainsList: document.getElementById('subdomainsList'),
  featuresGrid: document.getElementById('featuresGrid'),
  
  // Buttons
  upgradePlanBtn: document.getElementById('upgradePlanBtn'),
  refreshBtn: document.getElementById('refreshBtn'),
  deleteAllBtn: document.getElementById('deleteAllBtn'),
  createSubdomainBtn: document.getElementById('createSubdomainBtn'),
  
  // Modals
  planModal: document.getElementById('planModal'),
  subdomainModal: document.getElementById('subdomainModal'),
  
  // Form elements
  subdomainName: document.getElementById('subdomainName'),
  subdomainType: document.getElementById('subdomainType'),
  displayName: document.getElementById('displayName'),
  subdomainDesc: document.getElementById('subdomainDesc'),
  createSubdomainSubmitBtn: document.getElementById('createSubdomainSubmitBtn'),
  cancelSubdomainBtn: document.getElementById('cancelSubdomainBtn'),
  confirmUpgradeBtn: document.getElementById('confirmUpgradeBtn'),
  cancelPlanBtn: document.getElementById('cancelPlanBtn'),
  planCards: document.querySelectorAll('.plan-card'),
  
  // Notification
  notification: document.getElementById('notification')
};

// Extract domain from URL if not set
function extractDomainFromURL() {
  const path = window.location.pathname;
  if (path.startsWith('/dashboard/')) {
    const parts = path.split('/');
    if (parts.length >= 3) {
      MAIN_DOMAIN = parts[2];
      console.log("‚úÖ Extracted MAIN_DOMAIN from URL:", MAIN_DOMAIN);
    }
  }
}

// Initialize
function init() {
  console.log("üìä Dashboard loaded");
  
  // Try to extract domain from URL
  extractDomainFromURL();
  
  // Update UI
  updateDashboardInfo();
  renderFeatures();
  
  // Setup event listeners
  setupEventListeners();
  
  // Load subdomains after delay
  setTimeout(() => {
    if (MAIN_DOMAIN) {
      loadSubdomains();
    } else {
      showError("Domain not detected. Please check the URL.");
    }
  }, 500);
}

// Update dashboard information
function updateDashboardInfo() {
  // Update school name
  elements.schoolName.textContent = SCHOOL_NAME;
  
  // Update domain badge
  elements.domainBadge.textContent = MAIN_DOMAIN || 'domain';
  
  // Update plan badge
  elements.planText.textContent = PLAN.toUpperCase();
  
  // Update plan cards selection
  elements.planCards.forEach(card => {
    const plan = card.getAttribute('data-plan');
    if (plan === PLAN.toLowerCase()) {
      card.classList.add('selected');
    } else {
      card.classList.remove('selected');
    }
  });
}

// Render features grid
function renderFeatures() {
  let html = '';
  
  FEATURES.forEach(feature => {
    const isUnlocked = isFeatureUnlocked(feature.requires);
    const isActive = PLAN.toLowerCase() === feature.requires;
    
    html += `
      <div class="feature-card ${isUnlocked ? '' : 'locked'} ${isActive ? 'active' : ''}" 
           data-feature="${feature.id}">
        <div class="feature-icon">${feature.icon}</div>
        <h3>${feature.name}</h3>
        <p>${feature.desc}</p>
        ${!isUnlocked ? `<div style="margin-top: 0.5rem; font-size: 0.75rem; color: #f59e0b;">Requires: ${feature.requires.toUpperCase()}</div>` : ''}
      </div>
    `;
  });
  
  elements.featuresGrid.innerHTML = html;
}

// Check if feature is unlocked
function isFeatureUnlocked(requiredPlan) {
  const planLevels = { basic: 1, intermediate: 2, pro: 3 };
  const currentPlan = PLAN.toLowerCase();
  
  return planLevels[currentPlan] >= planLevels[requiredPlan];
}

// Setup all event listeners
function setupEventListeners() {
  // Button click events
  elements.upgradePlanBtn.addEventListener('click', openPlanModal);
  elements.refreshBtn.addEventListener('click', loadSubdomains);
  elements.deleteAllBtn.addEventListener('click', deleteAllSubdomains);
  elements.createSubdomainBtn.addEventListener('click', openSubdomainModal);
  
  // Form submission
  elements.createSubdomainSubmitBtn.addEventListener('click', createSubdomain);
  
  // Cancel buttons
  elements.cancelSubdomainBtn.addEventListener('click', closeSubdomainModal);
  elements.cancelPlanBtn.addEventListener('click', closePlanModal);
  
  // Plan selection
  elements.planCards.forEach(card => {
    card.addEventListener('click', () => {
      elements.planCards.forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const selectedPlan = card.getAttribute('data-plan');
      elements.confirmUpgradeBtn.textContent = selectedPlan === 'basic' ? 'Select Free Plan' : `Upgrade to ${selectedPlan.toUpperCase()}`;
    });
  });
  
  // Upgrade confirmation
  elements.confirmUpgradeBtn.addEventListener('click', () => {
    const selectedCard = document.querySelector('.plan-card.selected');
    if (selectedCard) {
      const selectedPlan = selectedCard.getAttribute('data-plan');
      fakePay(selectedPlan);
    }
  });
  
  // Close modals when clicking outside
  document.addEventListener('click', (e) => {
    if (e.target === elements.planModal) closePlanModal();
    if (e.target === elements.subdomainModal) closeSubdomainModal();
  });
  
  // Enter key to submit subdomain form
  elements.subdomainName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') createSubdomain();
  });
}

// Modal Functions
function openPlanModal() {
  elements.planModal.style.display = "flex";
}

function closePlanModal() {
  elements.planModal.style.display = "none";
}

function openSubdomainModal() {
  elements.subdomainModal.style.display = "flex";
  setTimeout(() => elements.subdomainName.focus(), 100);
}

function closeSubdomainModal() {
  elements.subdomainModal.style.display = "none";
  elements.subdomainName.value = "";
  elements.displayName.value = "";
  elements.subdomainDesc.value = "";
}

// Fake payment/upgrade
function fakePay(plan) {
  PLAN = plan.toUpperCase();
  closePlanModal();
  updateDashboardInfo();
  renderFeatures();
  showNotification(`üéâ Plan upgraded to ${PLAN}! You now have access to all ${plan} features.`, "success");
}

// Notification
function showNotification(message, type = "success") {
  elements.notification.textContent = message;
  elements.notification.style.background = type === "success" ? "#10b981" : "#ef4444";
  elements.notification.style.display = "block";
  
  setTimeout(() => {
    elements.notification.style.display = "none";
  }, 3000);
}

// Error display
function showError(message) {
  elements.subdomainsList.innerHTML = `
    <div class="empty-state">
      <div class="icon">‚ö†Ô∏è</div>
      <h3>Error Loading Data</h3>
      <p>${message}</p>
      <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer;">
        üîÑ Reload Page
      </button>
    </div>
  `;
}

// Create Subdomain
function createSubdomain() {
  const subdomain = elements.subdomainName.value.trim();
  const type = elements.subdomainType.value;
  const name = elements.displayName.value.trim() || subdomain;
  const description = elements.subdomainDesc.value.trim();
  
  if (!subdomain) {
    showNotification("‚ùå Subdomain name is required", "error");
    return;
  }
  
  if (!MAIN_DOMAIN) {
    showNotification("‚ùå Main domain not found", "error");
    return;
  }
  
  // Validate format
  if (!/^[a-zA-Z0-9]+$/.test(subdomain)) {
    showNotification("‚ùå Only letters and numbers allowed", "error");
    return;
  }
  
  console.log("üì§ Creating subdomain:", { mainDomain: MAIN_DOMAIN, subdomain, type, name });
  
  fetch("/create-subdomain", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mainDomain: MAIN_DOMAIN,
      subdomain: subdomain,
      type: type,
      name: name,
      description: description
    })
  })
  .then(res => res.json())
  .then(data => {
    console.log("üì• Response:", data);
    
    if (data.error) {
      showNotification("‚ùå " + data.error, "error");
    } else {
      showNotification("‚úÖ " + data.message, "success");
      closeSubdomainModal();
      
      // Reload subdomains list
      setTimeout(() => loadSubdomains(), 500);
      
      // Open new subdomain in new tab
      if (data.accessLink) {
        setTimeout(() => window.open(data.accessLink, '_blank'), 1000);
      }
    }
  })
  .catch(error => {
    console.error("‚ùå Fetch error:", error);
    showNotification("‚ùå Network error. Please try again.", "error");
  });
}

// Load Subdomains
function loadSubdomains() {
  console.log("üì° Loading subdomains for:", MAIN_DOMAIN);
  
  if (!MAIN_DOMAIN) {
    showError("Main domain not set. Please check the URL.");
    return;
  }
  
  elements.subdomainCount.textContent = "Loading...";
  elements.subdomainsList.innerHTML = `
    <div class="empty-state">
      <div class="icon">‚è≥</div>
      <h3>Loading Subdomains</h3>
      <p>Please wait while we load your data...</p>
    </div>
  `;
  
  fetch(`/get-subdomains/${MAIN_DOMAIN}`)
    .then(res => {
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    })
    .then(data => {
      console.log("üì¶ Subdomains data:", data);
      
      if (!data.success || data.error) {
        showError(data.error || 'Failed to load subdomains');
        elements.subdomainCount.textContent = "0 Created";
        return;
      }
      
      const subdomains = data.subdomains || [];
      elements.subdomainCount.textContent = `${subdomains.length} Created`;
      
      if (subdomains.length === 0) {
        elements.subdomainsList.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì≠</div>
            <h3>No Subdomains Yet</h3>
            <p>Create your first subdomain to get started</p>
          </div>
        `;
        return;
      }
      
      // Display subdomains
      renderSubdomains(subdomains);
    })
    .catch(error => {
      console.error("‚ùå Error loading subdomains:", error);
      showError(error.message);
      elements.subdomainCount.textContent = "Error";
    });
}

// Render subdomains list
function renderSubdomains(subdomains) {
  let html = '';
  
  subdomains.forEach((sub, index) => {
    const badgeClass = `${sub.type}-badge`;
    const badgeText = sub.type.charAt(0).toUpperCase() + sub.type.slice(1);
    const createdDate = new Date(sub.createdAt).toLocaleDateString();
    
    let icon = "üë§";
    if (sub.type === 'teacher') icon = "üë®‚Äçüè´";
    if (sub.type === 'student') icon = "üë®‚Äçüéì";
    if (sub.type === 'public') icon = "üåê";
    
    // Use new fields or fallback to old ones
    const uniqueId = sub.uniqueId || sub.subdomain;
    const qrCodeUrl = sub.qrCodeUrl || `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(sub.fullUrl || window.location.origin + '/' + MAIN_DOMAIN + '/' + uniqueId)}`;
    const fullUrl = sub.fullUrl || window.location.origin + '/' + MAIN_DOMAIN + '/' + uniqueId;
    const shortCode = sub.shortCode || uniqueId.substring(0, 8);
    
    html += `
      <div class="subdomain-item">
        <div class="subdomain-header">
          <div class="subdomain-type">
            <span class="type-badge ${badgeClass}">${badgeText}</span>
            <span class="subdomain-name">${icon} ${sub.name}</span>
          </div>
          <span class="subdomain-date">${createdDate}</span>
        </div>
        
        ${sub.description ? `
        <div class="subdomain-description">
          üìù ${sub.description}
        </div>
        ` : ''}
        
        <div class="qr-container">
          <img src="${qrCodeUrl}" alt="QR Code" class="qr-small">
          <div class="qr-label">Scan to open</div>
        </div>
        
        <div class="id-display">
          <strong>ID:</strong> ${shortCode}
        </div>
        
        <div class="subdomain-actions">
          <button class="action-small view-btn" onclick="window.open('${fullUrl}', '_blank')">
            <span>üëÅÔ∏è</span> View
          </button>
          <button class="action-small copy-btn" onclick="copyToClipboard('${fullUrl}')">
            <span>üìã</span> Copy
          </button>
          <button class="action-small delete-btn" onclick="deleteSubdomain('${uniqueId}', '${sub.name}')">
            <span>üóëÔ∏è</span> Delete
          </button>
        </div>
      </div>
    `;
  });
  
  elements.subdomainsList.innerHTML = html;
}

// Copy to clipboard
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showNotification('‚úÖ Link copied to clipboard!', 'success');
  });
}

// Delete Subdomain
function deleteSubdomain(uniqueId, displayName) {
  if (!confirm(`Are you sure you want to delete "${displayName}"?`)) return;
  
  fetch(`/delete-subdomain/${MAIN_DOMAIN}/${uniqueId}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotification("‚úÖ " + data.message, "success");
      loadSubdomains();
    } else {
      showNotification("‚ùå " + data.error, "error");
    }
  })
  .catch(error => {
    console.error("Delete error:", error);
    showNotification("‚ùå Network error", "error");
  });
}

// Delete All Subdomains
function deleteAllSubdomains() {
  if (!confirm("‚ö†Ô∏è Are you sure you want to delete ALL subdomains?\n\nThis action cannot be undone!")) return;
  
  fetch(`/delete-all-subdomains/${MAIN_DOMAIN}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotification("‚úÖ " + data.message, "success");
      loadSubdomains();
    } else {
      showNotification("‚ùå " + data.error, "error");
    }
  })
  .catch(error => {
    console.error("Delete all error:", error);
    showNotification("‚ùå Network error", "error");
  });
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', init);

// Make functions available globally
window.openSubdomainModal = openSubdomainModal;
window.openPlanModal = openPlanModal;
window.loadSubdomains = loadSubdomains;
window.deleteAllSubdomains = deleteAllSubdomains;
window.copyToClipboard = copyToClipboard;
window.deleteSubdomain = deleteSubdomain;
</script>
</body>
</html>
